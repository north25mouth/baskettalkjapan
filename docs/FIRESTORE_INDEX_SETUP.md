# Firestore インデックス設定ガイド

## 概要

Firestoreでは、複数のフィールドでフィルタリングやソートを行う場合、複合インデックスが必要になります。

## 必要なインデックス

### 1. スレッド検索用インデックス

**コレクション**: `threads`

**フィールド**:
- `team_id` (昇順)
- `type` (昇順)
- `created_at` (降順)

**用途**: チーム別スレッドの検索とソート

**作成方法**:
1. エラーメッセージに含まれるURLをクリック
2. または、[Firebase Console](https://console.firebase.google.com/) → Firestore Database → インデックス → インデックスを作成

**エラーメッセージのURL例**:
```
https://console.firebase.google.com/v1/r/project/baskettalkjapan/firestore/indexes?create_composite=Ck9wcm9qZWN0cy9iYXNrZXR0YWxramFwYW4vZGF0YWJhc2VzLyhkZWZhdWx0KS9jb2xsZWN0aW9uR3JvdXBzL3RocmVhZHMvaW5kZXhlcy9fEAEaCwoHdGVhbV9pZBABGggKBHR5cGUQARoOCgpjcmVhdGVkX2F0EAIaDAoIX19uYW1lX18QAg
```

### 2. 投稿検索用インデックス（オプション）

**コレクション**: `posts`

**フィールド**:
- `thread_id` (昇順)
- `deleted_flag` (昇順)
- `created_at` (昇順)

**用途**: スレッド別投稿の検索とソート

**注意**: 現在の実装では、インデックスがなくても動作するようにフォールバック処理を実装しています。パフォーマンス向上のため、インデックスの作成を推奨します。

## インデックスの作成手順

### 方法1: エラーメッセージのURLから作成（推奨）

1. ブラウザのコンソールでエラーメッセージを確認
2. エラーメッセージに含まれるURLをクリック
3. Firebase Consoleでインデックス作成画面が開く
4. 「インデックスを作成」をクリック
5. インデックスの作成が完了するまで待つ（数分かかる場合があります）

### 方法2: Firebase Consoleから手動で作成

1. [Firebase Console](https://console.firebase.google.com/)にアクセス
2. プロジェクト「baskettalkjapan」を選択
3. 「Firestore Database」を開く
4. 「インデックス」タブを開く
5. 「インデックスを作成」をクリック
6. 以下の設定を入力：
   - **コレクションID**: `threads`
   - **フィールドを追加**:
     - `team_id` (昇順)
     - `type` (昇順)
     - `created_at` (降順)
7. 「作成」をクリック

## インデックスの状態確認

インデックスの作成には数分かかる場合があります。Firebase Consoleでインデックスの状態を確認できます：

- **構築中**: インデックスを作成中
- **有効**: インデックスが使用可能
- **エラー**: インデックスの作成に失敗

## 現在の実装

現在の実装では、インデックスが存在しない場合でも動作するように、フォールバック処理を実装しています：

1. まず、`type`のみでフィルタリング
2. クライアント側で`team_id`でフィルタリング

この方法では、すべてのチームスレッドを取得してからフィルタリングするため、パフォーマンスは劣りますが、インデックスがなくても動作します。

## パフォーマンスの最適化

インデックスを作成することで、以下のメリットがあります：

1. **クエリの高速化**: データベース側でフィルタリングされるため、転送データ量が減る
2. **コストの削減**: 読み取り回数が減る
3. **スケーラビリティ**: データ量が増えてもパフォーマンスが維持される

## トラブルシューティング

### インデックスが作成されない

- Firebase Consoleでプロジェクトの状態を確認
- 請求先アカウントが設定されているか確認（無料枠でも必要）

### インデックスが有効にならない

- インデックスの状態を確認（構築中の場合、完了まで待つ）
- エラーメッセージを確認

### エラーが続く

- ブラウザをリフレッシュ
- 開発サーバーを再起動
- Firebase Consoleでインデックスの状態を再確認
